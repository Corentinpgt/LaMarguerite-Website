{# templates/backoffice/libs_dropzone/dropzone.js.twig #}

<script>
var myDropzone;
var uploadsCPT = 0;
</script>

<script>

function handleUploadsStates(action)
{
	if (action == 'sending')
	{
		uploadsCPT++;
	}
	else
	{
		uploadsCPT--;
	}

	if(uploadsCPT > 0)
	{
		$("#submitBtn").prop('disabled', true);
	}
	else
	{
		$("#submitBtn").prop('disabled', false);
	}
}

$(function() {

	var uploadsCPT = 0;

	var _actionToDropZone = $("#myDropzoneBox").attr('action');
	Dropzone.autoDiscover = false;
	myDropzone = new Dropzone("#myDropzoneBox",
	{
		url: _actionToDropZone,
		addRemoveLinks: true,
		timeout: -1
	});

	myDropzone.on("sending", function(file, xhr, formData) {
		formData.append("uuid", file.upload.uuid);
		handleUploadsStates('sending');

		{% if article is defined and article is not null %}
			formData.append("article_id", {{ article.id }});
		{% endif %}

		{% if news is defined and news is not null %}
			formData.append("news_id", {{ news.id }});
		{% endif %}
	});

	myDropzone.on("complete", function(file) {
		handleUploadsStates('complete');
	});

	myDropzone.on("canceled", function(file) {
		handleUploadsStates('canceled');
	});

	myDropzone.on("error", function(file, errorMessage) {
		$(file.previewElement).find('.dz-error-message').text(errorMessage.message)
	});

	// When a file is removed from the Dropzone, also remove it from the server
	myDropzone.on("removedfile", function(file) {

	  $.ajax({
			type: "POST",
			url: "{{ path('image_remove_dropzone') }}",
			data: {uuid: file.upload.uuid }
		})
		.done(function(data){

			if (typeof data.status != "undefined" && data.status != "undefined")
			{
				if (data.status == "Done")
				{

				}
				else
				{
					if (data.status == "Error")
					{
						toastr.error('Erreur', "{{ 'alert_error' | trans }}" );
					}
				}
			}
		});
	});
});

function getDropzoneFiles()
{
	dzFiles = myDropzone.getAcceptedFiles();
	files = [];

	for (pos = 0 ; pos < dzFiles.length ; pos ++)
	{
		file = dzFiles[pos];
		uuid = file.upload.uuid;

		files.push(uuid);
	}

	return JSON.stringify(files);
}

function removeFiles()
{
	myDropzone.removeAllFiles();
}
</script>
